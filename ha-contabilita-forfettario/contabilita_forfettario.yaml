# ==========================================
# Package: Contabilità Forfettario
# Progetto: ha-contabilita-forfettario
# Versione: 1.0.0
# ==========================================


# --------------------------
# Input Numbers
# --------------------------

input_number:
  anno_inizio_attivita:
    name: Anno Inizio Attività
    min: 2000
    max: 2100
    step: 1
    mode: box

  coefficiente_redditivita:
    name: Coefficiente Redditività
    min: 0
    max: 1
    step: 0.01
    mode: box

  contributi_inps_anno_precedente:
    name: Contributi INPS Anno Precedente
    min: 0
    max: 100000
    step: 1
    unit_of_measurement: "€"
    mode: box

  ricavi_annui:
    name: Ricavi Annui
    min: 0
    max: 85000
    step: 100
    unit_of_measurement: "€"
    mode: box

  imposta_netta_anno_precedente:
    name: Imposta Netta Anno Precedente
    min: 0
    max: 50000
    step: 10
    unit_of_measurement: "€"
    mode: box
    
# --------------------------
# Sensori Template
# --------------------------

template:
  - sensor:
      - name: "Utile Netto Stimato"
        unique_id: utile_netto_stimato
        state: >
          {{
            states('input_number.ricavi_annui') | float
            - states('sensor.carico_fiscale_reale') | float
          }}
        unit_of_measurement: "€"
#        state_class: measurement
        
      - name: "Acconto Giugno"
        unique_id: acconto_giugno
        state: >
          {{ states('sensor.acconto_totale_imposta') | float * 0.5 | round(2) }}
        unit_of_measurement: "€"
#        state_class: measurement
        
      - name: "Acconto Novembre"
        unique_id: acconto_novembre
        state: >
          {{ states('sensor.acconto_totale_imposta') | float * 0.5 | round(2) }}
        unit_of_measurement: "€"
#        state_class: measurement

      - name: "Acconto Totale Imposta"
        unique_id: acconto_totale_imposta
        state: >
         {% set imp = states('sensor.imposta_netta_anno_precedente') | float %}
          {% if imp < 257 %}
            0
          {% else %}
            {{ imp | round(2) }}
          {% endif %}
        unit_of_measurement: "€"
#        state_class: measurement
        
      - name: "Aliquota Imposta Forfettario"
        unique_id: aliquota_imposta_forfettario
        state: >
          {% set anno_corrente = now().year %}
          {% set anno_start = states('input_number.anno_inizio_attivita') | int %}
            {% if (anno_corrente - anno_start) < 5 %}
              5
            {% else %}
              15
            {% endif %}
        unit_of_measurement: "%"
#        state_class: measurement

      - name: "Base Imponibile Anno Precedente"
        unique_id: base_imponibile_anno_precedente
        state: >
          {% set reddito = states('sensor.reddito_forfettario_anno_precedente') | float(0) %}
          {% set inps = states('input_number.contributi_inps_anno_precedente') | float(0) %}
          {% set base = reddito - inps %}
            {% if base > 0 %}
              {{ base | round(2) }}
            {% else %}
              0
            {% endif %}
        unit_of_measurement: "€"
#        state_class: measurement

      - name: "Base Imponibile Imposta"
        unique_id: base_imponibile_imposta
        state: >
          {{ states('sensor.reddito_forfettario') | float - states('sensor.contributi_inps') | float | round(2)}}
        unit_of_measurement: "€"
#        state_class: measurement
        
      - name: "Carico Fiscale Reale"
        unique_id: carico_fiscale_reale
        state: >
          {{
            states('sensor.contributi_inps') | float
            + states('sensor.imposta_sostitutiva') | float
            | round(2)
          }}
        unit_of_measurement: "€"
#        state_class: measurement
        
      - name: "Contributi INPS"
        unique_id: contributi_inps
        state: >
          {{ states('sensor.reddito_forfettario') | float * 0.26 | round(2) }}
        unit_of_measurement: "€"
#        state_class: measurement
        
      - name: "Imposta Netta Anno Precedente"
        unique_id: imposta_netta_anno_precedente
        state: >
          {% set base = states('sensor.base_imponibile_anno_precedente') | float(0) %}
          {% set anno_corrente = now().year %}
          {% set anno_start = states('input_number.anno_inizio_attivita') | int %}
          {% set aliquota = 5 if (anno_corrente - anno_start - 1) < 5 else 15 %}
          {% if base > 0 %}
            {{ (base * aliquota / 100) | round(2) }}
          {% else %}
            0
          {% endif %}
        unit_of_measurement: "€"
#        state_class: measurement
        
      - name: "Imposta Sostitutiva"
        unique_id: imposta_sostitutiva
        state: >
          {{
            states('sensor.base_imponibile_imposta') | float
            * (states('sensor.aliquota_imposta_forfettario') | float / 100)
            | round(2)
          }}
        unit_of_measurement: "€"
#        state_class: measurement
        
      - name: "Reddito Forfettario"
        unique_id: reddito_forfettario
        state: >
          {{
          states('input_number.ricavi_annui') | float(0)
          * states('input_number.coefficiente_redditivita') | float(0.78)
          | round(2)
          }}
        unit_of_measurement: "€"
        state_class: measurement

      - name: "Reddito Forfettario Anno Precedente"
        unique_id: reddito_forfettario_anno_precedente
        state: >
          {% set ricavi = states('sensor.ricavi_anno_precedente') | float(0) %}
          {% set coeff = states('input_number.coefficiente_redditivita') | float(0.78) %}
          {{ (ricavi * coeff) | round(2) }}
        unit_of_measurement: "€"
#        state_class: measurement

      - name: "Ricavi Anno Precedente"
        unique_id: ricavi_anno_precedente
        state: >
          {% if states('sensor.ricavi_annui_last_year') not in ['unknown', 'unavailable', ''] %}
          {{ states('sensor.ricavi_annui_last_year') | float(0) | round(2) }}
          {% else %}
            0
          {% endif %}
        unit_of_measurement: "€"
#        state_class: measurement

      - name: "Ricavi Annui"
        unique_id: ricavi_annui_2
        state: >
          {{ states('input_number.ricavi_annui') | float(0) }}
        unit_of_measurement: "€"
#        state_class: measurement

# --------------------------
# Utility Meter
# --------------------------

utility_meter:
  ricavi_annui:
    source: sensor.ricavi_annui_2
    cycle: yearly

